# Rust/WASM Build Configuration
# This file defines build settings and optimization parameters

# Rust compilation settings
rust:
  version: stable
  targets:
    - wasm32-unknown-unknown
    - x86_64-unknown-linux-gnu
    - x86_64-apple-darwin
    - x86_64-pc-windows-msvc

  # Compiler flags
  flags:
    release:
      - "-C opt-level=3"
      - "-C lto=fat"
      - "-C codegen-units=1"
      - "-C strip=symbols"
    dev:
      - "-C opt-level=0"
      - "-C debug-assertions=on"

# WASM-specific configuration
wasm:
  # wasm-pack settings
  pack:
    target: web
    scope: "@meta-media-search"
    mode:
      dev:
        - "--dev"
        - "--target web"
      release:
        - "--release"
        - "--target web"

  # wasm-opt optimization levels
  optimization:
    levels:
      minimal: "-O1"
      standard: "-O2"
      aggressive: "-O3 -Oz"
      size: "-Oz --strip-debug --strip-producers"

    features:
      - "--enable-simd"
      - "--enable-bulk-memory"
      - "--enable-reference-types"
      - "--enable-threads"

    # Size optimization
    size_optimization:
      - "--converge"
      - "--strip-debug"
      - "--strip-producers"
      - "--remove-unused-functions"
      - "--merge-blocks"
      - "--vacuum"

# Testing configuration
testing:
  frameworks:
    - wasm-pack
    - cargo-test
    - playwright

  browsers:
    - chrome
    - firefox
    - safari
    - edge

  mobile:
    - android-chrome
    - ios-safari

  coverage:
    enabled: true
    threshold: 80
    tools:
      - cargo-tarpaulin
      - llvm-cov

# Performance benchmarking
benchmarking:
  enabled: true
  frameworks:
    - criterion
    - cargo-bench

  metrics:
    - execution_time
    - memory_usage
    - wasm_size
    - load_time
    - rendering_time

  thresholds:
    max_wasm_size: "2MB"
    max_load_time: "500ms"
    max_execution_time: "100ms"

# Security settings
security:
  audit:
    enabled: true
    tools:
      - cargo-audit
      - cargo-deny

  advisories:
    deny:
      - "RUSTSEC-*"

  dependency_checks:
    - license_compliance
    - vulnerability_scan
    - outdated_detection

# Cache configuration
cache:
  enabled: true
  directories:
    - "~/.cargo/registry"
    - "~/.cargo/git"
    - "target"

  strategies:
    - hash: "Cargo.lock"
      fallback: true

# Artifact management
artifacts:
  outputs:
    - "pkg/*.wasm"
    - "pkg/*.js"
    - "pkg/*.d.ts"
    - "pkg/*.json"

  retention:
    development: 7
    staging: 14
    production: 90

  compression:
    enabled: true
    formats:
      - gzip
      - brotli

# Docker build settings
docker:
  backend:
    base_image: "rust:1.75-alpine"
    build_stage: "builder"
    runtime_stage: "alpine:3.19"

  frontend:
    base_image: "nginx:alpine"
    wasm_dir: "/usr/share/nginx/html/wasm"

# Deployment configuration
deployment:
  environments:
    staging:
      cdn: "staging-cdn.example.com"
      containers: "staging-k8s"

    production:
      cdn: "cdn.example.com"
      containers: "prod-k8s"
      approval_required: true

  strategies:
    - blue_green
    - canary
    - rolling

# Hooks integration
hooks:
  pre_build:
    - "npx claude-flow@alpha hooks pre-task --description 'Starting Rust/WASM build'"

  post_build:
    - "npx claude-flow@alpha hooks post-edit --file 'Cargo.toml' --memory-key 'swarm/rust/build'"

  post_test:
    - "npx claude-flow@alpha hooks notify --message 'Tests completed'"

  post_deploy:
    - "npx claude-flow@alpha hooks post-task --task-id 'deploy'"
    - "npx claude-flow@alpha hooks session-end --export-metrics true"

# Feature flags
features:
  simd: true
  threads: true
  bulk_memory: true
  reference_types: true
  multi_value: true
  tail_call: false

# Logging and monitoring
logging:
  level: info
  format: json

monitoring:
  metrics:
    - build_time
    - test_coverage
    - benchmark_results
    - deployment_status

  alerts:
    - type: build_failure
      channel: github_issues
    - type: test_failure
      channel: slack
    - type: performance_regression
      channel: email
